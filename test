#!/bin/bash
# Enhanced DNS Management Script for Termux
# Version 2.0

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# Global variables
CONFIG_FILE="$HOME/.dns_config"
NAMESERVERS_FILE="$HOME/.nameservers"
DNS_FILE="$HOME/.dns_list"
LOOP_DELAY=0
DIG_COUNT=0

# Function to show banner
show_banner() {
    clear
    echo -e "${BLUE}╔══════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║${CYAN}        DNS Management & Digging Tool      ${BLUE}║${NC}"
    echo -e "${BLUE}║${YELLOW}           Created for Termux             ${BLUE}║${NC}"
    echo -e "${BLUE}╚══════════════════════════════════════════╝${NC}"
}

# Function to log messages
log_message() {
    local message=$1
    echo -e "$message"
}

# DNS Management Functions
manage_dns() {
    while true; do
        show_banner
        echo -e "\n${CYAN}DNS Management Menu:${NC}"
        echo -e "${WHITE}1.${NC} Add DNS"
        echo -e "${WHITE}2.${NC} Remove DNS"
        echo -e "${WHITE}3.${NC} View Current DNS"
        echo -e "${WHITE}4.${NC} Back to Main Menu"
        echo
        read -p "Enter your choice (1-4): " dns_choice

        case $dns_choice in
            1)
                echo -e "\n${YELLOW}Enter DNS to add:${NC}"
                read dns_entry
                if [[ -n "$dns_entry" ]]; then
                    echo "$dns_entry" >> "$DNS_FILE"
                    log_message "${GREEN}DNS added successfully!${NC}"
                else
                    log_message "${RED}Invalid DNS entry!${NC}"
                fi
                sleep 1
                ;;
            2)
                if [ -s "$DNS_FILE" ]; then
                    echo -e "\n${CYAN}Current DNS entries:${NC}"
                    nl -w2 -s". " "$DNS_FILE"
                    echo -e "\n${YELLOW}Enter line number to remove:${NC}"
                    read line_num
                    if [[ "$line_num" =~ ^[0-9]+$ ]] && [ "$line_num" -le "$(wc -l < "$DNS_FILE")" ]; then
                        sed -i "${line_num}d" "$DNS_FILE"
                        log_message "${GREEN}DNS removed successfully!${NC}"
                    else
                        log_message "${RED}Invalid line number!${NC}"
                    fi
                else
                    log_message "${RED}No DNS entries found!${NC}"
                fi
                sleep 1
                ;;
            3)
                echo -e "\n${CYAN}Current DNS entries:${NC}"
                if [ -s "$DNS_FILE" ]; then
                    nl -w2 -s". " "$DNS_FILE"
                else
                    log_message "${RED}No DNS entries found!${NC}"
                fi
                read -n 1 -s -r -p "Press any key to continue..."
                ;;
            4) return ;;
            *) log_message "${RED}Invalid option!${NC}"; sleep 1 ;;
        esac
    done
}

# Nameserver Management Functions
manage_nameserver() {
    while true; do
        show_banner
        echo -e "\n${CYAN}Nameserver Management Menu:${NC}"
        echo -e "${WHITE}1.${NC} Add Nameserver"
        echo -e "${WHITE}2.${NC} Remove Nameserver"
        echo -e "${WHITE}3.${NC} View Current Nameservers"
        echo -e "${WHITE}4.${NC} Back to Main Menu"
        echo
        read -p "Enter your choice (1-4): " ns_choice

        case $ns_choice in
            1)
                echo -e "\n${YELLOW}Enter nameserver to add:${NC}"
                read ns_entry
                if [[ -n "$ns_entry" ]]; then
                    echo "$ns_entry" >> "$NAMESERVERS_FILE"
                    log_message "${GREEN}Nameserver added successfully!${NC}"
                else
                    log_message "${RED}Invalid nameserver entry!${NC}"
                fi
                sleep 1
                ;;
            2)
                if [ -s "$NAMESERVERS_FILE" ]; then
                    echo -e "\n${CYAN}Current nameservers:${NC}"
                    nl -w2 -s". " "$NAMESERVERS_FILE"
                    echo -e "\n${YELLOW}Enter line number to remove:${NC}"
                    read line_num
                    if [[ "$line_num" =~ ^[0-9]+$ ]] && [ "$line_num" -le "$(wc -l < "$NAMESERVERS_FILE")" ]; then
                        sed -i "${line_num}d" "$NAMESERVERS_FILE"
                        log_message "${GREEN}Nameserver removed successfully!${NC}"
                    else
                        log_message "${RED}Invalid line number!${NC}"
                    fi
                else
                    log_message "${RED}No nameservers found!${NC}"
                fi
                sleep 1
                ;;
            3)
                echo -e "\n${CYAN}Current nameservers:${NC}"
                if [ -s "$NAMESERVERS_FILE" ]; then
                    nl -w2 -s". " "$NAMESERVERS_FILE"
                else
                    log_message "${RED}No nameservers found!${NC}"
                fi
                read -n 1 -s -r -p "Press any key to continue..."
                ;;
            4) return ;;
            *) log_message "${RED}Invalid option!${NC}"; sleep 1 ;;
        esac
    done
}

# Set Loop Delay
set_loop_delay() {
    while true; do
        echo -e "\n${CYAN}Current loop delay:${NC} ${LOOP_DELAY} seconds"
        echo -e "${YELLOW}Enter new loop delay (0-5 seconds):${NC}"
        read new_delay
        if [[ "$new_delay" =~ ^[0-5]$ ]]; then
            LOOP_DELAY=$new_delay
            echo "$LOOP_DELAY" > "$CONFIG_FILE"
            log_message "${GREEN}Loop delay updated successfully!${NC}"
            sleep 1
            return
        else
            log_message "${RED}Invalid input! Please enter a number between 0 and 5.${NC}"
            sleep 1
        fi
    done
}

# Function to measure real ping time
measure_ping() {
    local dns=$1
    local nameserver=$2
    local start_time
    local end_time
    local response
    
    # Send three pings and take the average
    local total_time=0
    local successful_pings=0
    
    for i in {1..3}; do
        start_time=$(date +%s.%N)
        if response=$(dig @"$dns" "$nameserver" +tries=1 +time=2 2>/dev/null); then
            end_time=$(date +%s.%N)
            # Calculate milliseconds with bc for better precision
            ping_time=$(echo "($end_time - $start_time) * 1000" | bc)
            total_time=$(echo "$total_time + $ping_time" | bc)
            successful_pings=$((successful_pings + 1))
        fi
    done
    
    # Calculate average if we had successful pings
    if [ $successful_pings -gt 0 ]; then
        echo "scale=2; $total_time / $successful_pings" | bc
        return 0
    else
        echo "0"
        return 1
    fi
}

# Start Digging Function
start_digging() {
    if [ ! -s "$DNS_FILE" ] || [ ! -s "$NAMESERVERS_FILE" ]; then
        log_message "${RED}Error: Please configure DNS and nameservers first!${NC}"
        sleep 2
        return
    fi

    show_banner
    echo -e "\n${CYAN}Starting DNS dig process...${NC}"
    echo -e "${YELLOW}Press Ctrl+C to stop${NC}\n"

    while true; do
        while read -r dns; do
            while read -r nameserver; do
                ping_result=$(measure_ping "$dns" "$nameserver")
                if [ $(echo "$ping_result > 0" | bc) -eq 1 ]; then
                    STATUS="${GREEN}SUCCESS${NC}"
                    PING_MS=$(printf "%.2f" $ping_result)
                else
                    STATUS="${RED}FAILED${NC}"
                    PING_MS="0.00"
                fi
                echo -e "DNS:${CYAN}${dns}${NC} NS:${BLUE}${nameserver}${NC} Status:${STATUS} ${YELLOW}${PING_MS}ms${NC} Count:${DIG_COUNT}"
                DIG_COUNT=$((DIG_COUNT + 1))
            done < "$NAMESERVERS_FILE"
        done < "$DNS_FILE"
        echo -e "${BLUE}────────────────────────────────────────${NC}"
        [ "$LOOP_DELAY" -gt 0 ] && sleep "$LOOP_DELAY"
    done
}

# Initialize files
touch "$CONFIG_FILE" "$NAMESERVERS_FILE" "$DNS_FILE"
[ -s "$CONFIG_FILE" ] && LOOP_DELAY=$(cat "$CONFIG_FILE")

# Main Menu
while true; do
    show_banner
    echo -e "\n${CYAN}Main Menu:${NC}"
    echo -e "${WHITE}1.${NC} DNS Management"
    echo -e "${WHITE}2.${NC} Nameserver Management"
    echo -e "${WHITE}3.${NC} Set Loop Delay (Current: ${LOOP_DELAY}s)"
    echo -e "${WHITE}4.${NC} Start Digging"
    echo -e "${WHITE}5.${NC} Exit"
    echo
    read -p "Enter your choice (1-5): " choice

    case $choice in
        1) manage_dns ;;
        2) manage_nameserver ;;
        3) set_loop_delay ;;
        4) start_digging ;;
        5) 
            log_message "\n${GREEN}Thank you for using DNS Management Tool!${NC}"
            exit 0
            ;;
        *) log_message "${RED}Invalid option!${NC}"; sleep 1 ;;
    esac
done
