#!/bin/bash
# TFN VPN DNS Script
# Version 2.1

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Global variables
VER="2.1"
DIG_COUNT=0
NS=()
HOSTS=()
LOOP_DELAY=0
CONFIG_FILE="$HOME/.tfn_vpn_config"

# Function to clear screen and show banner
show_banner() {
    clear
    echo -e "${BLUE}╔════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║${CYAN}           TFN VPN DNS Script              ${BLUE}║${NC}"
    echo -e "${BLUE}║${CYAN}             Version: ${VER}               ${BLUE}║${NC}"
    echo -e "${BLUE}╚════════════════════════════════════════════╝${NC}"
}

# Function to save configuration
save_config() {
    echo "NS=${NS[*]}" > "$CONFIG_FILE"
    echo "HOSTS=${HOSTS[*]}" >> "$CONFIG_FILE"
    echo "LOOP_DELAY=$LOOP_DELAY" >> "$CONFIG_FILE"
}

# Function to load configuration
load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        source "$CONFIG_FILE"
        IFS=' ' read -ra NS <<< "$NS"
        IFS=' ' read -ra HOSTS <<< "$HOSTS"
        return 0
    fi
    return 1
}

# DNS Management Menu
dns_menu() {
    local choice
    while true; do
        show_banner
        echo -e "\n${CYAN}DNS Management Menu:${NC}"
        echo -e "${BLUE}╔════════════════════════╗${NC}"
        echo -e "${BLUE}║${NC} 1. Add DNS            ${BLUE}║${NC}"
        echo -e "${BLUE}║${NC} 2. Remove DNS         ${BLUE}║${NC}"
        echo -e "${BLUE}║${NC} 3. View Current DNS   ${BLUE}║${NC}"
        echo -e "${BLUE}║${NC} 4. Back to Main Menu  ${BLUE}║${NC}"
        echo -e "${BLUE}╚════════════════════════╝${NC}"
        echo
        read -p "Enter your choice (1-4): " choice

        case $choice in
            1)  read -p "Enter DNS to add: " dns
                HOSTS+=("$dns")
                save_config
                echo -e "${GREEN}DNS added successfully!${NC}"
                sleep 1
                ;;
            2)  if [ ${#HOSTS[@]} -eq 0 ]; then
                    echo -e "${RED}No DNS entries to remove!${NC}"
                else
                    echo -e "\n${CYAN}Current DNS entries:${NC}"
                    for i in "${!HOSTS[@]}"; do
                        echo "$((i+1)). ${HOSTS[$i]}"
                    done
                    read -p "Enter number to remove: " num
                    if [ $num -le ${#HOSTS[@]} ] && [ $num -gt 0 ]; then
                        unset 'HOSTS[$((num-1))]'
                        HOSTS=("${HOSTS[@]}")
                        save_config
                        echo -e "${GREEN}DNS removed successfully!${NC}"
                    else
                        echo -e "${RED}Invalid selection!${NC}"
                    fi
                fi
                sleep 1
                ;;
            3)  echo -e "\n${CYAN}Current DNS entries:${NC}"
                if [ ${#HOSTS[@]} -eq 0 ]; then
                    echo -e "${YELLOW}No DNS configured${NC}"
                else
                    for i in "${!HOSTS[@]}"; do
                        echo "$((i+1)). ${HOSTS[$i]}"
                    done
                fi
                read -n 1 -s -r -p "Press any key to continue..."
                ;;
            4)  return ;;
            *)  echo -e "${RED}Invalid option!${NC}"
                sleep 1
                ;;
        esac
    done
}

# Nameserver Management Menu
nameserver_menu() {
    local choice
    while true; do
        show_banner
        echo -e "\n${CYAN}Nameserver Management Menu:${NC}"
        echo -e "${BLUE}╔════════════════════════════╗${NC}"
        echo -e "${BLUE}║${NC} 1. Add Nameserver         ${BLUE}║${NC}"
        echo -e "${BLUE}║${NC} 2. Remove Nameserver      ${BLUE}║${NC}"
        echo -e "${BLUE}║${NC} 3. View Current Nameserver${BLUE}║${NC}"
        echo -e "${BLUE}║${NC} 4. Back to Main Menu      ${BLUE}║${NC}"
        echo -e "${BLUE}╚════════════════════════════╝${NC}"
        echo
        read -p "Enter your choice (1-4): " choice

        case $choice in
            1)  read -p "Enter nameserver to add: " ns
                NS+=("$ns")
                save_config
                echo -e "${GREEN}Nameserver added successfully!${NC}"
                sleep 1
                ;;
            2)  if [ ${#NS[@]} -eq 0 ]; then
                    echo -e "${RED}No nameservers to remove!${NC}"
                else
                    echo -e "\n${CYAN}Current nameservers:${NC}"
                    for i in "${!NS[@]}"; do
                        echo "$((i+1)). ${NS[$i]}"
                    done
                    read -p "Enter number to remove: " num
                    if [ $num -le ${#NS[@]} ] && [ $num -gt 0 ]; then
                        unset 'NS[$((num-1))]'
                        NS=("${NS[@]}")
                        save_config
                        echo -e "${GREEN}Nameserver removed successfully!${NC}"
                    else
                        echo -e "${RED}Invalid selection!${NC}"
                    fi
                fi
                sleep 1
                ;;
            3)  echo -e "\n${CYAN}Current nameservers:${NC}"
                if [ ${#NS[@]} -eq 0 ]; then
                    echo -e "${YELLOW}No nameservers configured${NC}"
                else
                    for i in "${!NS[@]}"; do
                        echo "$((i+1)). ${NS[$i]}"
                    done
                fi
                read -n 1 -s -r -p "Press any key to continue..."
                ;;
            4)  return ;;
            *)  echo -e "${RED}Invalid option!${NC}"
                sleep 1
                ;;
        esac
    done
}

# Function to set loop delay
set_loop_delay() {
    while true; do
        show_banner
        echo -e "\n${CYAN}Current loop delay:${NC} ${LOOP_DELAY} seconds"
        read -p "Enter new loop delay (0-5 seconds): " new_delay
        if [[ $new_delay =~ ^[0-5]$ ]]; then
            LOOP_DELAY=$new_delay
            save_config
            echo -e "${GREEN}Loop delay updated successfully!${NC}"
            sleep 1
            return
        else
            echo -e "${RED}Invalid input. Please enter a number between 0 and 5.${NC}"
            sleep 1
        fi
    done
}

# Function to check dig command
check_dig() {
    if command -v dig >/dev/null 2>&1; then
        _DIG="$(command -v dig)"
        return 0
    elif [ -f "/data/data/com.termux/files/home/go/bin/fastdig" ]; then
        _DIG="/data/data/com.termux/files/home/go/bin/fastdig"
        return 0
    else
        echo -e "${RED}Error: 'dig' command not found. Please install dnsutils or configure fastdig.${NC}"
        return 1
    fi
}

# Function to check DNS
check_dns() {
    for ((i=0; i<"${#HOSTS[*]}"; i++)); do
        for R in "${NS[@]}"; do
            T="${HOSTS[$i]}"
            if timeout -k 3 3 ${_DIG} @${T} ${R} >/dev/null 2>&1; then
                STATUS="${GREEN}SUCCESS${NC}"
            else
                STATUS="${RED}FAILED${NC}"
            fi
            echo -e "NS:${BLUE}${R}${NC} DNS:${CYAN}${T}${NC} Status:${STATUS} Count:${DIG_COUNT}"
            DIG_COUNT=$((DIG_COUNT + 1))
        done
    done
}

# Function to start digging
start_digging() {
    if [ ${#NS[@]} -eq 0 ] || [ ${#HOSTS[@]} -eq 0 ]; then
        echo -e "${RED}Error: Please configure both DNS and nameserver settings first.${NC}"
        sleep 2
        return
    }
    
    clear
    echo -e "${YELLOW}Digging Started${NC}"
    echo -e "${CYAN}DNS List:${NC} ${HOSTS[*]}"
    echo -e "${CYAN}NS List:${NC} ${NS[*]}"
    echo -e "${CYAN}Loop Delay:${NC} ${LOOP_DELAY} seconds"
    echo -e "\n${YELLOW}Press Ctrl+C to stop digging${NC}\n"
    
    while true; do
        check_dns
        echo -e "${BLUE}────────────────────────────────────────${NC}"
        if [ ${LOOP_DELAY} -gt 0 ]; then
            sleep ${LOOP_DELAY}
        fi
    done
}

# Main menu function
main_menu() {
    local choice
    while true; do
        show_banner
        echo -e "\n${CYAN}Main Menu:${NC}"
        echo -e "${BLUE}╔════════════════════════╗${NC}"
        echo -e "${BLUE}║${NC} 1. DNS Management      ${BLUE}║${NC}"
        echo -e "${BLUE}║${NC} 2. Nameserver Management${BLUE}║${NC}"
        echo -e "${BLUE}║${NC} 3. Set Loop Delay      ${BLUE}║${NC}"
        echo -e "${BLUE}║${NC} 4. Start Digging       ${BLUE}║${NC}"
        echo -e "${BLUE}║${NC} 5. Exit                ${BLUE}║${NC}"
        echo -e "${BLUE}╚════════════════════════╝${NC}"
        echo
        read -p "Enter your choice (1-5): " choice
        
        case $choice in
            1) dns_menu ;;
            2) nameserver_menu ;;
            3) set_loop_delay ;;
            4) start_digging ;;
            5) echo -e "\n${GREEN}Thank you for using TFN VPN DNS Script!${NC}"; exit 0 ;;
            *) echo -e "${RED}Invalid option. Please try again.${NC}"; sleep 1 ;;
        esac
    done
}

# Cleanup function
cleanup() {
    echo -e "\n${YELLOW}Cleaning up and exiting...${NC}"
    exit 1
}

# Set up trap for cleanup
trap cleanup 2 15

# Initial setup
check_dig || exit 1
load_config

# Start the program
main_menu
